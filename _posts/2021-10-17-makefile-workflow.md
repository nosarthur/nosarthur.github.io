---
layout: post
title: Automate data processing workflow with Makefile on cluster
date:   2021-10-17 13:43:08 -0500
categories: [coding]
comments: true
tags: [Makefile, workflow, HPC]
---

Recently I automated a few data processing workflows using Makefile.
One complication is that my jobs run through a job control system
without blocking calls. This means

1. running `make` once is not enough since it exits at the first non-blocking call
1. running `make` repeatedly is wasteful since any unfinished job will be
   re-submitted

Employing sentinel files is my solution.
Overall it works, and takes little time to write.
The maintenance cost is yet to be seen.

<svg id="mermaid-svg" width="100%" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" height="670" style="max-width: 406px;" viewBox="0 0 406 670"><style>#mermaid-svg {font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}#mermaid-svg .error-icon{fill:#552222;}#mermaid-svg .error-text{fill:#552222;stroke:#552222;}#mermaid-svg .edge-thickness-normal{stroke-width:2px;}#mermaid-svg .edge-thickness-thick{stroke-width:3.5px;}#mermaid-svg .edge-pattern-solid{stroke-dasharray:0;}#mermaid-svg .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-svg .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-svg .marker{fill:#333333;stroke:#333333;}#mermaid-svg .marker.cross{stroke:#333333;}#mermaid-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#mermaid-svg .cluster-label text{fill:#333;}#mermaid-svg .cluster-label span{color:#333;}#mermaid-svg .label text,#mermaid-svg span{fill:#333;color:#333;}#mermaid-svg .node rect,#mermaid-svg .node circle,#mermaid-svg .node ellipse,#mermaid-svg .node polygon,#mermaid-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#mermaid-svg .node .label{text-align:center;}#mermaid-svg .node.clickable{cursor:pointer;}#mermaid-svg .arrowheadPath{fill:#333333;}#mermaid-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#mermaid-svg .flowchart-link{stroke:#333333;fill:none;}#mermaid-svg .edgeLabel{background-color:#e8e8e8;text-align:center;}#mermaid-svg .edgeLabel rect{opacity:0.5;background-color:#e8e8e8;fill:#e8e8e8;}#mermaid-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#mermaid-svg .cluster text{fill:#333;}#mermaid-svg .cluster span{color:#333;}#mermaid-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#mermaid-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><g class="output"><g class="clusters"></g><g class="edgePaths"><g class="edgePath LS-a LE-b" id="L-a-b" style="opacity: 1;"><path class="path" d="M203,46L203,50.166666666666664C203,54.333333333333336,203,62.666666666666664,203,71C203,79.33333333333333,203,87.66666666666667,203,91.83333333333333L203,96" marker-end="url(#arrowhead55)" style="fill:none"></path><defs><marker id="arrowhead55" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-b LE-c1" id="L-b-c1" style="opacity: 1;"><path class="path" d="M188.5,122.25L176.25,128.375C164,134.5,139.5,146.75,127.25,157.04166666666666C115,167.33333333333334,115,175.66666666666666,115,179.83333333333334L115,184" marker-end="url(#arrowhead56)" style="fill:none"></path><defs><marker id="arrowhead56" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-b LE-c2" id="L-b-c2" style="opacity: 1;"><path class="path" d="M203,134L203,138.16666666666666C203,142.33333333333334,203,150.66666666666666,203,159C203,167.33333333333334,203,175.66666666666666,203,179.83333333333334L203,184" marker-end="url(#arrowhead57)" style="fill:none"></path><defs><marker id="arrowhead57" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-b LE-c3" id="L-b-c3" style="opacity: 1;"><path class="path" d="M217.5,119.83333333333333L237.08333333333334,126.3611111111111C256.6666666666667,132.88888888888889,295.8333333333333,145.94444444444443,315.4166666666667,156.63888888888889C335,167.33333333333334,335,175.66666666666666,335,179.83333333333334L335,184" marker-end="url(#arrowhead58)" style="fill:none"></path><defs><marker id="arrowhead58" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-c1 LE-d1" id="L-c1-d1" style="opacity: 1;"><path class="path" d="M115,222L115,226.16666666666666C115,230.33333333333334,115,238.66666666666666,115,247C115,255.33333333333334,115,263.6666666666667,115,267.8333333333333L115,272" marker-end="url(#arrowhead59)" style="fill:none"></path><defs><marker id="arrowhead59" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-d1 LE-e1" id="L-d1-e1" style="opacity: 1;"><path class="path" d="M96,300.5L84.5,306.25C73,312,50,323.5,38.5,333.4166666666667C27,343.3333333333333,27,351.6666666666667,27,355.8333333333333L27,360" marker-end="url(#arrowhead60)" style="fill:none"></path><defs><marker id="arrowhead60" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-d1 LE-e2" id="L-d1-e2" style="opacity: 1;"><path class="path" d="M115,310L115,314.1666666666667C115,318.3333333333333,115,326.6666666666667,115,335C115,343.3333333333333,115,351.6666666666667,115,355.8333333333333L115,360" marker-end="url(#arrowhead61)" style="fill:none"></path><defs><marker id="arrowhead61" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-d1 LE-e3" id="L-d1-e3" style="opacity: 1;"><path class="path" d="M134,300.5L145.5,306.25C157,312,180,323.5,191.5,333.4166666666667C203,343.3333333333333,203,351.6666666666667,203,355.8333333333333L203,360" marker-end="url(#arrowhead62)" style="fill:none"></path><defs><marker id="arrowhead62" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-c2 LE-d2" id="L-c2-d2" style="opacity: 1;"><path class="path" d="M203,222L203,226.16666666666666C203,230.33333333333334,203,238.66666666666666,203,247C203,255.33333333333334,203,263.6666666666667,203,267.8333333333333L203,272" marker-end="url(#arrowhead63)" style="fill:none"></path><defs><marker id="arrowhead63" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-c3 LE-d3" id="L-c3-d3" style="opacity: 1;"><path class="path" d="M335,222L335,226.16666666666666C335,230.33333333333334,335,238.66666666666666,335,247C335,255.33333333333334,335,263.6666666666667,335,267.8333333333333L335,272" marker-end="url(#arrowhead64)" style="fill:none"></path><defs><marker id="arrowhead64" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-d3 LE-e4" id="L-d3-e4" style="opacity: 1;"><path class="path" d="M316,310L311.8333333333333,314.1666666666667C307.6666666666667,318.3333333333333,299.3333333333333,326.6666666666667,295.1666666666667,335C291,343.3333333333333,291,351.6666666666667,291,355.8333333333333L291,360" marker-end="url(#arrowhead65)" style="fill:none"></path><defs><marker id="arrowhead65" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-d3 LE-e5" id="L-d3-e5" style="opacity: 1;"><path class="path" d="M354,310L358.1666666666667,314.1666666666667C362.3333333333333,318.3333333333333,370.6666666666667,326.6666666666667,374.8333333333333,335C379,343.3333333333333,379,351.6666666666667,379,355.8333333333333L379,360" marker-end="url(#arrowhead66)" style="fill:none"></path><defs><marker id="arrowhead66" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-e1 LE-f1" id="L-e1-f1" style="opacity: 1;"><path class="path" d="M27,398L27,402.1666666666667C27,406.3333333333333,27,414.6666666666667,38.916666666666664,424.7916666666667C50.833333333333336,434.9166666666667,74.66666666666667,446.8333333333333,86.58333333333333,452.7916666666667L98.5,458.75" marker-end="url(#arrowhead67)" style="fill:none"></path><defs><marker id="arrowhead67" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-e2 LE-f1" id="L-e2-f1" style="opacity: 1;"><path class="path" d="M115,398L115,402.1666666666667C115,406.3333333333333,115,414.6666666666667,115,423C115,431.3333333333333,115,439.6666666666667,115,443.8333333333333L115,448" marker-end="url(#arrowhead68)" style="fill:none"></path><defs><marker id="arrowhead68" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-e3 LE-f1" id="L-e3-f1" style="opacity: 1;"><path class="path" d="M203,398L203,402.1666666666667C203,406.3333333333333,203,414.6666666666667,191.08333333333334,424.7916666666667C179.16666666666666,434.9166666666667,155.33333333333334,446.8333333333333,143.41666666666666,452.7916666666667L131.5,458.75" marker-end="url(#arrowhead69)" style="fill:none"></path><defs><marker id="arrowhead69" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-e4 LE-f3" id="L-e4-f3" style="opacity: 1;"><path class="path" d="M291,398L291,402.1666666666667C291,406.3333333333333,291,414.6666666666667,295.5833333333333,423.4166666666667C300.1666666666667,432.1666666666667,309.3333333333333,441.3333333333333,313.9166666666667,445.9166666666667L318.5,450.5" marker-end="url(#arrowhead70)" style="fill:none"></path><defs><marker id="arrowhead70" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-e5 LE-f3" id="L-e5-f3" style="opacity: 1;"><path class="path" d="M379,398L379,402.1666666666667C379,406.3333333333333,379,414.6666666666667,374.4166666666667,423.4166666666667C369.8333333333333,432.1666666666667,360.6666666666667,441.3333333333333,356.0833333333333,445.9166666666667L351.5,450.5" marker-end="url(#arrowhead71)" style="fill:none"></path><defs><marker id="arrowhead71" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-f1 LE-g1" id="L-f1-g1" style="opacity: 1;"><path class="path" d="M98.5,483.5L93.91666666666667,488.0833333333333C89.33333333333333,492.6666666666667,80.16666666666667,501.8333333333333,75.58333333333333,510.5833333333333C71,519.3333333333334,71,527.6666666666666,71,531.8333333333334L71,536" marker-end="url(#arrowhead72)" style="fill:none"></path><defs><marker id="arrowhead72" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-f1 LE-g2" id="L-f1-g2" style="opacity: 1;"><path class="path" d="M131.5,475.25L143.41666666666666,481.2083333333333C155.33333333333334,487.1666666666667,179.16666666666666,499.0833333333333,191.08333333333334,509.2083333333333C203,519.3333333333334,203,527.6666666666666,203,531.8333333333334L203,536" marker-end="url(#arrowhead73)" style="fill:none"></path><defs><marker id="arrowhead73" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-f3 LE-g3" id="L-f3-g3" style="opacity: 1;"><path class="path" d="M318.5,483.5L313.9166666666667,488.0833333333333C309.3333333333333,492.6666666666667,300.1666666666667,501.8333333333333,295.5833333333333,510.5833333333333C291,519.3333333333334,291,527.6666666666666,291,531.8333333333334L291,536" marker-end="url(#arrowhead74)" style="fill:none"></path><defs><marker id="arrowhead74" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-f3 LE-g4" id="L-f3-g4" style="opacity: 1;"><path class="path" d="M351.5,483.5L356.0833333333333,488.0833333333333C360.6666666666667,492.6666666666667,369.8333333333333,501.8333333333333,374.4166666666667,510.5833333333333C379,519.3333333333334,379,527.6666666666666,379,531.8333333333334L379,536" marker-end="url(#arrowhead75)" style="fill:none"></path><defs><marker id="arrowhead75" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-g1 LE-f" id="L-g1-f" style="opacity: 1;"><path class="path" d="M71,574L71,578.1666666666666C71,582.3333333333334,71,590.6666666666666,91,601.5C111,612.3333333333334,151,625.6666666666666,171,632.3333333333334L191,639" marker-end="url(#arrowhead76)" style="fill:none"></path><defs><marker id="arrowhead76" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-g2 LE-f" id="L-g2-f" style="opacity: 1;"><path class="path" d="M203,574L203,578.1666666666666C203,582.3333333333334,203,590.6666666666666,203,599C203,607.3333333333334,203,615.6666666666666,203,619.8333333333334L203,624" marker-end="url(#arrowhead77)" style="fill:none"></path><defs><marker id="arrowhead77" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-g3 LE-f" id="L-g3-f" style="opacity: 1;"><path class="path" d="M291,574L291,578.1666666666666C291,582.3333333333334,291,590.6666666666666,278.3333333333333,601.1666666666666C265.6666666666667,611.6666666666666,240.33333333333334,624.3333333333334,227.66666666666666,630.6666666666666L215,637" marker-end="url(#arrowhead78)" style="fill:none"></path><defs><marker id="arrowhead78" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-g4 LE-f" id="L-g4-f" style="opacity: 1;"><path class="path" d="M379,574L379,578.1666666666666C379,582.3333333333334,379,590.6666666666666,351.6666666666667,601.6666666666666C324.3333333333333,612.6666666666666,269.6666666666667,626.3333333333334,242.33333333333334,633.1666666666666L215,640" marker-end="url(#arrowhead79)" style="fill:none"></path><defs><marker id="arrowhead79" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g></g><g class="edgeLabels"><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span id="L-L-a-b" class="edgeLabel L-LS-a' L-LE-b"></span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span id="L-L-b-c1" class="edgeLabel L-LS-b' L-LE-c1"></span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span id="L-L-b-c2" class="edgeLabel L-LS-b' L-LE-c2"></span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span id="L-L-b-c3" class="edgeLabel L-LS-b' L-LE-c3"></span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span id="L-L-c1-d1" class="edgeLabel L-LS-c1' L-LE-d1"></span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span id="L-L-d1-e1" class="edgeLabel L-LS-d1' L-LE-e1"></span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span id="L-L-d1-e2" class="edgeLabel L-LS-d1' L-LE-e2"></span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span id="L-L-d1-e3" class="edgeLabel L-LS-d1' L-LE-e3"></span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span id="L-L-c2-d2" class="edgeLabel L-LS-c2' L-LE-d2"></span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span id="L-L-c3-d3" class="edgeLabel L-LS-c3' L-LE-d3"></span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span id="L-L-d3-e4" class="edgeLabel L-LS-d3' L-LE-e4"></span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span id="L-L-d3-e5" class="edgeLabel L-LS-d3' L-LE-e5"></span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span id="L-L-e1-f1" class="edgeLabel L-LS-e1' L-LE-f1"></span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span id="L-L-e2-f1" class="edgeLabel L-LS-e2' L-LE-f1"></span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span id="L-L-e3-f1" class="edgeLabel L-LS-e3' L-LE-f1"></span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span id="L-L-e4-f3" class="edgeLabel L-LS-e4' L-LE-f3"></span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span id="L-L-e5-f3" class="edgeLabel L-LS-e5' L-LE-f3"></span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span id="L-L-f1-g1" class="edgeLabel L-LS-f1' L-LE-g1"></span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span id="L-L-f1-g2" class="edgeLabel L-LS-f1' L-LE-g2"></span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span id="L-L-f3-g3" class="edgeLabel L-LS-f3' L-LE-g3"></span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span id="L-L-f3-g4" class="edgeLabel L-LS-f3' L-LE-g4"></span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span id="L-L-g1-f" class="edgeLabel L-LS-g1' L-LE-f"></span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span id="L-L-g2-f" class="edgeLabel L-LS-g2' L-LE-f"></span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span id="L-L-g3-f" class="edgeLabel L-LS-g3' L-LE-f"></span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span id="L-L-g4-f" class="edgeLabel L-LS-g4' L-LE-f"></span></div></foreignObject></g></g></g><g class="nodes"><g class="node default" id="flowchart-a-35" transform="translate(203,27)" style="opacity: 1;"><rect rx="0" ry="0" x="-14.5" y="-19" width="29" height="38" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-4.5,-9)"><foreignObject width="9" height="18"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">a</div></foreignObject></g></g></g><g class="node default" id="flowchart-b-36" transform="translate(203,115)" style="opacity: 1;"><rect rx="0" ry="0" x="-14.5" y="-19" width="29" height="38" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-4.5,-9)"><foreignObject width="9" height="18"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">b</div></foreignObject></g></g></g><g class="node default" id="flowchart-c1-38" transform="translate(115,203)" style="opacity: 1;"><rect rx="0" ry="0" x="-18.5" y="-19" width="37" height="38" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-8.5,-9)"><foreignObject width="17" height="18"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">c1</div></foreignObject></g></g></g><g class="node default" id="flowchart-c2-39" transform="translate(203,203)" style="opacity: 1;"><rect rx="0" ry="0" x="-18.5" y="-19" width="37" height="38" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-8.5,-9)"><foreignObject width="17" height="18"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">c2</div></foreignObject></g></g></g><g class="node default" id="flowchart-c3-40" transform="translate(335,203)" style="opacity: 1;"><rect rx="0" ry="0" x="-18.5" y="-19" width="37" height="38" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-8.5,-9)"><foreignObject width="17" height="18"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">c3</div></foreignObject></g></g></g><g class="node default" id="flowchart-d1-42" transform="translate(115,291)" style="opacity: 1;"><rect rx="0" ry="0" x="-19" y="-19" width="38" height="38" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-9,-9)"><foreignObject width="18" height="18"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">d1</div></foreignObject></g></g></g><g class="node default" id="flowchart-e1-43" transform="translate(27,379)" style="opacity: 1;"><rect rx="0" ry="0" x="-19" y="-19" width="38" height="38" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-9,-9)"><foreignObject width="18" height="18"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">e1</div></foreignObject></g></g></g><g class="node default" id="flowchart-e2-44" transform="translate(115,379)" style="opacity: 1;"><rect rx="0" ry="0" x="-19" y="-19" width="38" height="38" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-9,-9)"><foreignObject width="18" height="18"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">e2</div></foreignObject></g></g></g><g class="node default" id="flowchart-e3-45" transform="translate(203,379)" style="opacity: 1;"><rect rx="0" ry="0" x="-19" y="-19" width="38" height="38" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-9,-9)"><foreignObject width="18" height="18"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">e3</div></foreignObject></g></g></g><g class="node default" id="flowchart-d2-47" transform="translate(203,291)" style="opacity: 1;"><rect rx="0" ry="0" x="-19" y="-19" width="38" height="38" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-9,-9)"><foreignObject width="18" height="18"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">d2</div></foreignObject></g></g></g><g class="node default" id="flowchart-d3-49" transform="translate(335,291)" style="opacity: 1;"><rect rx="0" ry="0" x="-19" y="-19" width="38" height="38" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-9,-9)"><foreignObject width="18" height="18"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">d3</div></foreignObject></g></g></g><g class="node default" id="flowchart-e4-50" transform="translate(291,379)" style="opacity: 1;"><rect rx="0" ry="0" x="-19" y="-19" width="38" height="38" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-9,-9)"><foreignObject width="18" height="18"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">e4</div></foreignObject></g></g></g><g class="node default" id="flowchart-e5-51" transform="translate(379,379)" style="opacity: 1;"><rect rx="0" ry="0" x="-19" y="-19" width="38" height="38" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-9,-9)"><foreignObject width="18" height="18"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">e5</div></foreignObject></g></g></g><g class="node default" id="flowchart-f1-55" transform="translate(115,467)" style="opacity: 1;"><rect rx="0" ry="0" x="-16.5" y="-19" width="33" height="38" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-6.5,-9)"><foreignObject width="13" height="18"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">f1</div></foreignObject></g></g></g><g class="node default" id="flowchart-f3-58" transform="translate(335,467)" style="opacity: 1;"><rect rx="0" ry="0" x="-16.5" y="-19" width="33" height="38" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-6.5,-9)"><foreignObject width="13" height="18"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">f3</div></foreignObject></g></g></g><g class="node default" id="flowchart-g1-60" transform="translate(71,555)" style="opacity: 1;"><rect rx="0" ry="0" x="-19" y="-19" width="38" height="38" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-9,-10)"><foreignObject width="18" height="20"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">g1</div></foreignObject></g></g></g><g class="node default" id="flowchart-g2-61" transform="translate(203,555)" style="opacity: 1;"><rect rx="0" ry="0" x="-19" y="-19" width="38" height="38" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-9,-10)"><foreignObject width="18" height="20"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">g2</div></foreignObject></g></g></g><g class="node default" id="flowchart-g3-63" transform="translate(291,555)" style="opacity: 1;"><rect rx="0" ry="0" x="-19" y="-19" width="38" height="38" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-9,-10)"><foreignObject width="18" height="20"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">g3</div></foreignObject></g></g></g><g class="node default" id="flowchart-g4-64" transform="translate(379,555)" style="opacity: 1;"><rect rx="0" ry="0" x="-19" y="-19" width="38" height="38" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-9,-10)"><foreignObject width="18" height="20"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">g4</div></foreignObject></g></g></g><g class="node default" id="flowchart-f-69" transform="translate(203,643)" style="opacity: 1;"><rect rx="0" ry="0" x="-12" y="-19" width="24" height="38" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-4,-9)"><foreignObject width="8" height="18"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">h</div></foreignObject></g></g></g></g></g></g></svg>
> Figure 1: A generic workflow. Each node is a file, and the arrows denote
  script calls.


## pattern 1: output is well defined

This is the simplest situation. For example, the `a->b`
or `c->d` layers in Figure 1.

In this case, we can use an empty target as sentinel:
only run the job if `output` doesn't exist.
The empty `output` signals either a running job or a
failed job, preventing re-submission to occur.

```
output : input
    [ -f $@ -o ! -s $< ] || run @< && touch $@
```

Note that `-s @<` checks if `input` is a merely sentinel.
Omit if it is guaranteed to exist.

Equivalently, one can use the shell `if` statement
```
output : input
    if [ ! -f $@ -a -s $< ]; then \
        run $< && touch $@; fi
```

If the script gives rise to multiple well-defined output files, for example
the `f->g` layer in Firgure 1 (1 input to 2 outputs),
we can use one of them as `output`.
This ignores the edge case where the job dies right after generating `output`.
One workaround is to use the last file written to disk as `output`.
If this shortcut is a concern, use the next pattern.

A related trick for pattern 1 is the [Makefile pattern rule](https://www.gnu.org/software/make/manual/html_node/Pattern-Rules.html):
```
%output : %input
```
So we don't need to specify the dependencies explicitly.

## pattern 2: output is not well defined

Sometimes the number of output files is not pre-determined, see the `d->e` layer
in Figure 1 for example.
In this case, we can employ 2 sentinels:
a `input.running` created at job submission,
and a `input.done` created at job completion
(the `run @<` script writes it to disk).
```
input.done :  input
    [ -f $@ -o -f $<.running -o ! -s @< ] || run @< && touch $<.running
```

Supporse there are a series of such `inputs`, it may be useful to know if all
such jobs have finished.
```
inputs_done:=$(addsuffix .done,$(inputs))
ifeq ($(word $(inputs)), $(words inputs_done))
...
endif
```

## pattern 3: untouchable target
Sometimes the output is well-defined but it cannot be touched, making
pattern 1 unsuitable.
For example, some of my scripts have a directory as their output, and they don't
run if the directory already exists.
In this case, we can use a running sentinel:

```
output : input
    if [ ! -f $@.running -a -s $< ]; then \
        run $< && touch $@.running; fi
```

## pattern 4: waiting for all prerequisites

When multiple prerequisites exist,
for example the `e->f` or `g->h` layers in Figure 1,
we need to wait for all of them to be ready.

Suppose `$(inputs)` contains all the prerequisites, we must ensure that
they are not sentinels

```
output : inputs
	if (for x in $^;do [ -s $$x ] || exit; done); then \
        run $< && touch $@; fi
```

However, this rule only works if `inputs` is statically determined. If the
prerequisites are dynamically determined, say from

```
inputs:=$(wildcard *_my_pattern.abc)
```
extra check is needed.

The minimal check is
```
ifdef inputs
endif
```
which ensures `$(inputs)` is not empty.

The better check should examine the completion of all the scripts that generate
the prerequisites.

## clean up

To remove all the sentinels, use
```
clean:
    find . -empty -delete
```
It deletes all empty files and directories for all subdirectories.

## appendix

- A sentinel file without a running job indicates a failed job. To save human
  debugging effort, we must also create a `make` phony target to display the
  job/workflow status.
- If all jobs can run in blocking mode, all the sentinel tricks in this post are
  unnecessary. And it becomes trivial to hook up the workflow.
